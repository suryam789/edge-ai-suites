name: SIV Weekly Build Tagging

on:
  schedule:
    - cron: '0 15 * * 2'  # Every Tuesday at 15:00 UTC
  workflow_dispatch:

permissions: {}

jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Get latest commit SHA
      id: get-sha
      run: |
        COMMIT_SHA=$(curl -s -H "Authorization: token ${{ secrets.SIV_USER_TOKEN_GH }}" \
          https://api.github.com/repos/${{ github.repository }}/commits/main | jq -r '.sha')
        echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

    - name: Create lightweight tag via API
      run: |
        TAG_NAME="${{ vars.SIV_WEEKLY_BUILD_PREFIX }}-$(date +'%Y%m%d')"
        
        curl -X POST \
          -H "Authorization: token ${{ secrets.SIV_USER_TOKEN_GH }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/git/refs \
          -d "{
            \"ref\": \"refs/tags/${TAG_NAME}\",
            \"sha\": \"${{ steps.get-sha.outputs.sha }}\"
          }"
        
        echo "Created lightweight tag: ${TAG_NAME}"
