name: SIV Weekly Build Tagging

on:
  schedule:
    - cron: '0 15 * * 2'  # Every Tuesday at 15:00 UTC
  workflow_dispatch:

permissions: {}

jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Get latest commit SHA
      id: get-sha
      run: |
        COMMIT_SHA=$(curl -s -H "Authorization: Bearer ${{ secrets.SIV_USER_TOKEN_GH }}" \
          https://api.github.com/repos/${{ github.repository }}/commits/main | jq -r '.sha')
        echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

    - name: Create lightweight tag via API
      run: |
        TAG_NAME="${{ vars.SIV_WEEKLY_BUILD_PREFIX }}-$(date +'%Y%m%d')"
        
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.SIV_USER_TOKEN_GH }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/git/refs \
          -d "{
            \"ref\": \"refs/tags/${TAG_NAME}\",
            \"sha\": \"${{ steps.get-sha.outputs.sha }}\"
          }"
        
        printf "\n"
        printf "âœ… Weekly Build Tag Created Successfully!\n"
        printf "==========================================\n"
        printf "ğŸ“Œ Tag Name:     %s\n" "${TAG_NAME}"
        printf "ğŸ”— Commit SHA:   %s\n" "${{ steps.get-sha.outputs.sha }}"
        printf "ğŸ“ Repository:   %s\n" "${{ github.repository }}"
        printf "â° Created:      %s\n" "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        printf "ğŸŒ View Online:  https://github.com/%s/releases/tag/%s\n" "${{ github.repository }}" "${TAG_NAME}"
        printf "\n"
